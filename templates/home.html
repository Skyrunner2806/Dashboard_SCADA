{% extends "base.html" %}
{% block content %}

<style>
  /* CSS UNTUK MENJAMIN KONTRAS TEKS PADA BACKGROUND GELAP */
  .kpi-container {
    margin-bottom: 25px;
  }

  .kpi-card {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.03) 100%);
    border: 1px solid rgba(255, 255, 255, 0.15);
    padding: 22px;
    border-radius: 20px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    transition: all 0.3s ease;
    height: 100%;
    backdrop-filter: blur(8px);
  }

  .kpi-card:hover {
    transform: translateY(-5px);
    border-color: rgba(59, 130, 246, 0.5);
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  }

  .kpi-label {
    color: #CBD5E1 !important; 
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    margin-bottom: 12px;
    display: block;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  }

  .kpi-value {
    color: #FFFFFF !important; 
    font-size: 2.4rem;
    font-weight: 800;
    line-height: 1;
    display: flex;
    align-items: baseline;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.6);
  }

  .kpi-unit {
    color: #94A3B8 !important; 
    font-size: 1rem;
    font-weight: 500;
    margin-left: 8px;
  }

  .border-total { border-left: 6px solid #3B82F6 !important; }
  .border-high { border-left: 6px solid #EF4444 !important; }
  .border-low { border-left: 6px solid #FBBF24 !important; }

  /* Table styling */
  .table thead th {
    color: #FFFFFF !important;
    background-color: rgba(255,255,255,0.05);
    border-bottom: 2px solid rgba(255,255,255,0.1);
  }

  /* PAKSA SEMUA TEKS DI TABEL MENJADI PUTIH */
  .table-custom-white tbody td {
    color: #FFFFFF !important;
    font-weight: 500;
  }
</style>

<div class="page-head">
  <div>
    <h1 class="text-white fw-bold mb-1">Dashboard Monitoring Energi</h1>
    <div class="text-white-50">Analisis Konsumsi & Deteksi Anomali Berbasis Isolation Forest</div>
  </div>

  <form class="filter glass p-3" method="POST" action="{{ url_for('home') }}">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <div class="mini text-white-50 mb-1">Sumber Data</div>
        <select class="form-select form-select-sm" name="source">
          <option value="harvested" {% if source=='harvested' %}selected{% endif %}>API_Harvest_2023_2025.csv</option>
          <option value="default" {% if source=='default' %}selected{% endif %}>Data_Lengkap.csv</option>
        </select>
      </div>
      <div class="col-auto">
        <div class="mini text-white-50 mb-1">Dari</div>
        <input class="form-control form-control-sm" type="date" name="start" value="{{ start }}">
      </div>
      <div class="col-auto">
        <div class="mini text-white-50 mb-1">Sampai</div>
        <input class="form-control form-control-sm" type="date" name="end" value="{{ end }}">
      </div>
      <div class="col-auto">
        <div class="mini text-white-50 mb-1">Contamination</div>
        <input class="form-control form-control-sm" type="number" step="0.01" min="0.01" max="0.5" name="contamination" value="{{ contamination }}">
      </div>
      <div class="col-auto">
        <button class="btn btn-primary btn-sm px-4 fw-bold">Apply Filter</button>
      </div>
    </div>
  </form>
</div>

<div class="row g-3 kpi-container">
  <div class="col-md-4">
    <div class="kpi-card border-total">
      <span class="kpi-label">Total Konsumsi (Rentang Ini)</span>
      <div class="kpi-value">
        {{ "{:,.1f}".format(total_kwh).replace(",", "X").replace(".", ",").replace("X", ".") }}
        <span class="kpi-unit">kWh</span>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="kpi-card border-high">
      <span class="kpi-label text-danger" style="color: #F87171 !important;">Total High Usage</span>
      <div class="kpi-value">
        {{ high_usage_count }}
        <span class="kpi-unit">Data</span>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="kpi-card border-low">
      <span class="kpi-label text-warning" style="color: #FBBF24 !important;">Total Low Usage</span>
      <div class="kpi-value">
        {{ low_usage_count }}
        <span class="kpi-unit">Data</span>
      </div>
    </div>
  </div>
</div>

<div class="panel glass mb-4 p-3">
  {{ chart_line|safe }}
</div>

<div class="panel glass mb-4 p-3">
  {{ chart_hm|safe }}
</div>

<div class="panel glass p-0 overflow-hidden">
  <div class="panel-head p-3 d-flex justify-content-between align-items-center">
    <h5 class="m-0 text-white fw-bold">Detail 30 Anomali Terakhir</h5>
    <a class="btn btn-outline-light btn-sm" href="{{ url_for('download_anomalies', source=source, start=start, end=end, contamination=contamination) }}">
      <i class="bi bi-download me-1"></i> Unduh CSV
    </a>
  </div>
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle mb-0 table-custom-white">
      <thead>
        <tr>
          <th class="ps-3">Timestamp</th>
          <th>Status Hari</th>
          <th class="text-end">kWh</th>
          <th>Kategori</th>
          <th class="text-end pe-3">Severity Score</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td class="ps-3">{{ r.ts }}</td>
          <td>
            <span class="badge {% if r.status_hari=='Hari Libur' %}bg-secondary{% else %}bg-primary{% endif %}">
              {{ r.status_hari }}
            </span>
          </td>
          <td class="text-end fw-bold">{{ "{:,.2f}".format(r.kwh) }}</td>
          <td>
            <span class="badge {% if r.anom_category=='HIGH_USAGE' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
              {{ r.anom_category }}
            </span>
          </td>
          <td class="text-end pe-3">{{ "{:,.4f}".format(r.score) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}